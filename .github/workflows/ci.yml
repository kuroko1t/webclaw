name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: pnpm build

      - run: pnpm exec turbo run test:unit

  e2e:
    name: E2E Tests (${{ github.event_name == 'pull_request' && 'full' || 'smoke' }})
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Install Chrome for Testing
        run: |
          npx @puppeteer/browsers install chrome@stable --path /tmp/chrome-for-testing
          CHROME_BIN=$(find /tmp/chrome-for-testing -name chrome -type f | head -1)
          echo "CHROME_PATH=$CHROME_BIN" >> $GITHUB_ENV
          echo "Chrome for Testing: $CHROME_BIN"
          $CHROME_BIN --version

      - run: pnpm build

      - name: Debug - verify extension loads in Chrome
        run: |
          node -e "
            const puppeteer = require('puppeteer-core');
            const path = require('path');
            const DIST = path.resolve('packages/extension/dist');
            (async () => {
              console.log('Launching Chrome:', process.env.CHROME_PATH);
              console.log('Extension path:', DIST);
              const browser = await puppeteer.launch({
                headless: false,
                executablePath: process.env.CHROME_PATH,
                ignoreDefaultArgs: ['--disable-extensions', '--disable-component-extensions-with-background-pages'],
                args: ['--headless=new', '--disable-extensions-except=' + DIST, '--load-extension=' + DIST, '--no-sandbox', '--disable-setuid-sandbox', '--disable-gpu', '--disable-dev-shm-usage'],
              });
              console.log('Browser launched');
              const targets = await browser.targets();
              console.log('Targets:', targets.map(t => t.type() + ' ' + t.url()));
              const sw = await browser.waitForTarget(t => t.type() === 'service_worker', { timeout: 10000 }).catch(e => null);
              console.log('Service worker:', sw ? sw.url() : 'NOT FOUND');
              const page = await browser.newPage();
              await page.goto('data:text/html,<h1>test</h1>');
              console.log('Page loaded');
              await browser.close();
              console.log('Success');
            })().catch(e => { console.error(e); process.exit(1); });
          "
        timeout-minutes: 1

      - name: Run E2E smoke tests
        if: github.event_name == 'push'
        run: pnpm --filter @webclaw/extension test:e2e:smoke
        timeout-minutes: 5

      - name: Run full E2E tests
        if: github.event_name == 'pull_request'
        run: pnpm --filter @webclaw/extension test:e2e
        timeout-minutes: 15
